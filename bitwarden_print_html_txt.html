<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitwarden Export Printer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #175DDC;
      --primary-dark: #0c4fc0;
      --secondary-color: #eff3fd;
      --accent-color: #3c8dfd;
      --text-color: #333;
      --text-light: #666;
      --light-gray: #f5f7fa;
      --border-color: #ddd;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
      --border-radius: 8px;
      --container-width: 1200px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-color);
      line-height: 1.6;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 25px;
    }

    header {
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      margin-bottom: 30px;
    }

    .header-content {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      color: var(--primary-color);
      font-size: 24px;
      font-weight: 600;
    }

    h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary-dark);
    }

    h3 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin-bottom: 20px;
    }

    .file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px dashed var(--border-color);
      border-radius: var(--border-radius);
      padding: 30px 20px;
      text-align: center;
      background-color: var(--light-gray);
      transition: var(--transition);
      cursor: pointer;
      margin-bottom: 20px;
    }

    .file-upload:hover {
      border-color: var(--primary-color);
      background-color: var(--secondary-color);
    }

    .file-upload i {
      font-size: 40px;
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    .file-upload-text {
      font-size: 15px;
      margin-bottom: 10px;
    }

    .file-name {
      font-size: 14px;
      color: var(--text-light);
      margin-top: 10px;
      display: none;
    }

    #fileInput {
      display: none;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: white;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    .btn-secondary:hover {
      background-color: var(--secondary-color);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .folder-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px 0;
      border-radius: var(--border-radius);
    }

    .folder-list-inner {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .checkbox-item:hover {
      background-color: var(--secondary-color);
    }

    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary-color);
    }

    .folder-name {
      font-weight: 500;
    }

    #itemList {
      /* Allow full height, let page scroll instead of internal scrolling */
      padding: 5px;
    }

    .item-container {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .item-container:hover {
      background-color: var(--secondary-color);
    }

    .item-container label {
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .item-container input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    /* Print Preview Styles */
    .print-area {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 30px;
    }

    .print-area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-toggle {
      cursor: pointer;
      color: var(--primary-color);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .print-settings {
      background-color: var(--light-gray);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch input[type="checkbox"] {
      height: 0;
      width: 0;
      visibility: hidden;
      position: absolute;
    }

    .toggle-switch label {
      cursor: pointer;
      width: 50px;
      height: 24px;
      background: #ccc;
      display: block;
      border-radius: 100px;
      position: relative;
    }

    .toggle-switch label:after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 90px;
      transition: 0.3s;
    }

    .toggle-switch input:checked + label {
      background: var(--primary-color);
    }

    .toggle-switch input:checked + label:after {
      left: calc(100% - 3px);
      transform: translateX(-100%);
    }

    .item-detail {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-left: 4px solid var(--primary-color);
    }

    .item-detail h3 {
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .section-title {
      font-weight: 600;
      margin-top: 15px;
      margin-bottom: 8px;
      color: var(--text-light);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .login-section, .card-section, .identity-section, .ssh-section {
      margin-top: 15px;
    }

    .field-group {
      margin-bottom: 5px;
      display: flex;
    }

    .field-label {
      font-weight: 500;
      min-width: 120px;
      color: var(--text-light);
    }

    .field-value {
      word-break: break-all;
    }

    .notes {
      margin-top: 15px;
      padding: 10px;
      background-color: var(--light-gray);
      border-radius: 4px;
      font-style: italic;
      white-space: pre-wrap;
    }

    .qr-code {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }

    .uri-list {
      list-style-type: none;
      padding-left: 0;
    }

    .uri-list li {
      margin-bottom: 5px;
    }

    .uri-list a {
      color: var(--primary-color);
      text-decoration: none;
      word-break: break-all;
    }

    .uri-list a:hover {
      text-decoration: underline;
    }

    .additional-fields {
      margin-top: 15px;
    }

    .additional-fields ul {
      list-style-type: none;
      padding-left: 0;
    }

    .additional-fields li {
      margin-bottom: 8px;
      padding: 8px 10px;
      background-color: var(--light-gray);
      border-radius: 4px;
    }

    .no-items-message {
      text-align: center;
      padding: 30px;
      color: var(--text-light);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 40px;
      color: var(--border-color);
      margin-bottom: 15px;
    }

    /* Animation for loading */
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Print styles */
    @media print {
      body {
        background-color: white;
      }

      header, .sidebar, .print-settings, .print-area-header, .btn-group {
        display: none !important;
      }

      .container {
        display: block;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }

      .print-area {
        box-shadow: none;
        padding: 0;
        margin: 0;
      }

      .page-break {
        page-break-after: always !important;
        break-after: page !important;
      }

      .item-detail {
        break-inside: avoid;
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #eee;
      }
      
      /* Override blue colors for print */
      h3, .section-title, a, .settings-toggle, .toggle-switch input:checked + label {
        color: #000 !important;
      }
      
      .item-detail {
        border-left: 4px solid #000 !important;
      }
      
      /* QR code should be black when printing */
      .qr-code canvas, .qr-code img {
        filter: grayscale(100%) !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><i class="fas fa-shield-alt"></i> Bitwarden Export Printer</h1>
      <div class="btn-group">
        <button class="btn" id="printBtn"><i class="fas fa-print"></i> Print</button>
        <button class="btn btn-secondary" id="exportTxtBtn"><i class="fas fa-file-alt"></i> Export to TXT</button>
        <button class="btn btn-secondary" id="exportHtmlBtn"><i class="fas fa-file-code"></i> Export to HTML</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="sidebar">
      <div class="card">
        <div class="file-upload-container">
          <div class="file-upload" id="dropZone">
            <i class="fas fa-cloud-upload-alt"></i>
            <div class="file-upload-text">Drag and drop a JSON file or use the button below</div>
            <div class="file-name" id="fileName"></div>
          </div>
          <button id="uploadButton" class="btn" style="width: 100%; margin-top: 10px;">
          <i class="fas fa-file-upload"></i> Select JSON file
          </button>
          <input type="file" id="fileInput" accept="application/json" style="display: none;" />
        </div>
        
        <div id="folderCard" class="card" style="display: none;">
          <h2><i class="fas fa-folder"></i> Folders</h2>
          <div class="folder-list">
            <div class="folder-list-inner" id="folderList">
              <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>Load JSON file to display folders</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Typy elementów: filtrera wyboru typu (login, karta, tożsamość, notatka, SSH) -->
        <div id="typeCard" class="card" style="display: none;">
          <h2><i class="fas fa-filter"></i> Item Types</h2>
          <div class="folder-list" id="typeList">
            <div class="checkbox-item">
              <input type="checkbox" id="type_login" value="login" checked />
              <span>Login</span>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="type_card" value="card" checked />
              <span>Card</span>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="type_identity" value="identity" checked />
              <span>Identity</span>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="type_secureNote" value="secureNote" checked />
              <span>Secure Note</span>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="type_sshKey" value="sshKey" checked />
              <span>SSH Key</span>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <div class="print-area">
      <div class="print-area-header">
        <h2><i class="fas fa-eye"></i> Print Preview</h2>
        <div class="settings-toggle" id="settingsToggle">
          <i class="fas fa-cog"></i> Print Settings
        </div>
      </div>
      
      <div class="print-settings" id="printSettings">
        <div class="settings-group">
          <div class="toggle-switch">
            <input type="checkbox" id="pageBreakToggle" />
            <label for="pageBreakToggle"></label>
            <span>Print each item on a separate page</span>
          </div>
        </div>
      </div>
      
      <div id="printContent">
        <div class="empty-state">
          <i class="fas fa-file-alt"></i>
          <p>Load JSON file and select items to see print preview</p>
        </div>
      </div>
    </div>
  <div class="sidebar">
    <div id="itemCard" class="card" style="display: none;">
      <h2><i class="fas fa-key"></i> Elementy</h2>
      <div id="itemList">
        <div class="empty-state">
          <i class="fas fa-list"></i>
          <p>Select a folder to view items</p>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Global variables
    let data = null;
    const foldersSelected = new Set();
    const itemsSelected = new Set();
    const types = ['login','card','identity','secureNote','sshKey'];
    const typeLabels = {login:'Login',card:'Card',identity:'Identity',secureNote:'Secure Note',sshKey:'SSH Key'};
    let typesSelected = new Set(types);
    function getItemType(item) {
      if (item.identity) return 'identity';
      if (item.sshKey) return 'sshKey';
      if (item.login) return 'login';
      if (item.card) return 'card';
      return 'secureNote';
    }

    // DOM elements
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const folderCard = document.getElementById('folderCard');
    const itemCard = document.getElementById('itemCard');
    const folderList = document.getElementById('folderList');
    const itemList = document.getElementById('itemList');
    const printContent = document.getElementById('printContent');
    const pageBreakToggle = document.getElementById('pageBreakToggle');
    const printBtn = document.getElementById('printBtn');
    const exportTxtBtn = document.getElementById('exportTxtBtn');
    const exportHtmlBtn = document.getElementById('exportHtmlBtn');
    const settingsToggle = document.getElementById('settingsToggle');
    const printSettings = document.getElementById('printSettings');
    printSettings.style.display = 'none';
    const typeCard = document.getElementById('typeCard');
    const typeList = document.getElementById('typeList');
    types.forEach(type => {
      const cb = document.getElementById(`type_${type}`);
      if (cb) {
        cb.addEventListener('change', () => {
          if (cb.checked) typesSelected.add(type);
          else typesSelected.delete(type);
          renderItems();
          renderPrintPreview();
        });
      }
    });

    // Set up file selection functionality
    document.getElementById('uploadButton').addEventListener('click', function() {
      fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
      if (fileInput.files && fileInput.files.length > 0) {
        handleFileUpload(fileInput.files[0]);
      }
    });
    
    // Handle drop zone
    const dropZone = document.getElementById('dropZone');
    
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropZone.classList.add('file-upload-hover');
    });
    
    dropZone.addEventListener('dragleave', function() {
      dropZone.classList.remove('file-upload-hover');
    });
    
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropZone.classList.remove('file-upload-hover');
      
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        handleFileUpload(e.dataTransfer.files[0]);
      }
    });
    
    // Other event listeners
    pageBreakToggle.addEventListener('change', renderPrintPreview);
    printBtn.addEventListener('click', () => window.print());
    exportTxtBtn.addEventListener('click', exportToTxt);
    exportHtmlBtn.addEventListener('click', exportToHtml);
    settingsToggle.addEventListener('click', () => {
      printSettings.style.display = printSettings.style.display === 'none' ? 'block' : 'none';
    });
    
    // Handle file upload
    function handleFileUpload(file) {
      console.log('Handle file upload called with file:', file?.name);
      
      if (!file) {
        console.error('No file provided to handleFileUpload');
        return;
      }
      
      console.log('Processing file:', file.name);
      
      // Show filename
      fileName.textContent = file.name;
      fileName.style.display = 'block';
      
      // Change upload area text
      document.querySelector('.file-upload-text').textContent = 'File loaded! Click to change';
      
      // Add loading state
      folderList.innerHTML = '<div class="empty-state loading"><i class="fas fa-spinner"></i><p>Loading data...</p></div>';
      folderCard.style.display = 'block';
      typeCard.style.display = 'block';
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          data = JSON.parse(reader.result);
          // Domyślne zaznaczenie wszystkich folderów i elementów
          foldersSelected.clear();
          data.folders.forEach(f => foldersSelected.add(f.id));
          itemsSelected.clear();
          data.items.forEach(i => itemsSelected.add(i.id));
          // Renderuj i oznacz checkboxy
          renderFolders();
          updateAllCheckboxes(true);
          itemCard.style.display = 'block';
          renderItems();
          renderPrintPreview();
        } catch(e) {
          console.error('JSON parse error:', e);
          alert('Error reading JSON file');
          folderList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error reading JSON file</p></div>';
        }
      };
      
      reader.onerror = (error) => {
        console.error('FileReader error:', error);
        alert('Error reading file');
      };
      
      reader.readAsText(file);
    }

    // Render folders
    function renderFolders() {
      folderList.innerHTML = '';
      
      if (!data || !data.folders || data.folders.length === 0) {
        folderList.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>No folders in file</p></div>';
        return;
      }
      
      // Add 'All items' checkbox
      const allItemsLabel = document.createElement('div');
      allItemsLabel.className = 'checkbox-item';
      
      const allItemsCheckbox = document.createElement('input');
      allItemsCheckbox.type = 'checkbox';
      allItemsCheckbox.value = '__ALL_ITEMS__';
      allItemsCheckbox.id = 'all_items_checkbox';
      allItemsCheckbox.addEventListener('change', () => {
        if (allItemsCheckbox.checked) {
          data.items.forEach(i => itemsSelected.add(i.id));
          data.folders.forEach(f => foldersSelected.add(f.id));
          updateAllCheckboxes(true);
        } else {
          itemsSelected.clear();
          foldersSelected.clear();
          updateAllCheckboxes(false);
        }
        renderItems();
        renderPrintPreview();
      });
      
      allItemsLabel.appendChild(allItemsCheckbox);
      
      const allItemsSpan = document.createElement('span');
      allItemsSpan.className = 'folder-name';
      allItemsSpan.textContent = 'All items';
      allItemsLabel.appendChild(allItemsSpan);
      
      folderList.appendChild(allItemsLabel);
      
      // Add 'Items without folder' checkbox
      const noFolderLabel = document.createElement('div');
      noFolderLabel.className = 'checkbox-item';
      
      const noFolderCheckbox = document.createElement('input');
      noFolderCheckbox.type = 'checkbox';
      noFolderCheckbox.value = '__NO_FOLDER__';
      noFolderCheckbox.id = 'no_folder_checkbox';
      noFolderCheckbox.addEventListener('change', () => {
        if (noFolderCheckbox.checked) {
          data.items.forEach(i => {
            if (!i.folderId) itemsSelected.add(i.id);
          });
        } else {
          data.items.forEach(i => {
            if (!i.folderId) itemsSelected.delete(i.id);
          });
        }
        renderItems();
        renderPrintPreview();
      });
      
      noFolderLabel.appendChild(noFolderCheckbox);
      
      const noFolderSpan = document.createElement('span');
      noFolderSpan.className = 'folder-name';
      noFolderSpan.textContent = 'Items without folder';
      noFolderLabel.appendChild(noFolderSpan);
      
      folderList.appendChild(noFolderLabel);

      // Add separator
      const separator = document.createElement('div');
      separator.style.borderBottom = '1px solid #eee';
      separator.style.margin = '10px 0';
      folderList.appendChild(separator);

      // Add other folders
      data.folders.forEach(folder => {
        const label = document.createElement('div');
        label.className = 'checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = folder.id;
        checkbox.id = `folder_${folder.id}`;
        checkbox.checked = foldersSelected.has(folder.id);
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            foldersSelected.add(folder.id);
            data.items.forEach(i => {
              if (i.folderId === folder.id) itemsSelected.add(i.id);
            });
          } else {
            foldersSelected.delete(folder.id);
            data.items.forEach(i => {
              if (i.folderId === folder.id) itemsSelected.delete(i.id);
            });
          }
          renderItems();
          renderPrintPreview();
        });
        
        label.appendChild(checkbox);
        
        const span = document.createElement('span');
        span.className = 'folder-name';
        span.textContent = folder.name;
        label.appendChild(span);
        
        folderList.appendChild(label);
      });
    }

    // Update all checkboxes
    function updateAllCheckboxes(checked) {
      // Update folder checkboxes
      document.querySelectorAll('#folderList input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = checked;
      });
    }

    // Render items
    function renderItems() {
      itemList.innerHTML = '';
      
      if (!data || !data.items || data.items.length === 0) {
        itemList.innerHTML = '<div class="empty-state"><i class="fas fa-list"></i><p>No items in file</p></div>';
        return;
      }
      
      const filteredItems = data.items.filter(item => {
        const inFolder = (item.folderId && foldersSelected.has(item.folderId))
                         || (!item.folderId && document.querySelector('#no_folder_checkbox')?.checked);
        if (!inFolder) return false;
        const type = getItemType(item);
        return typesSelected.has(type);
      });
      
      if (filteredItems.length === 0) {
        itemList.innerHTML = '<div class="empty-state"><i class="fas fa-filter"></i><p>Select a folder to view items</p></div>';
        return;
      }

      filteredItems.forEach(item => {
        const container = document.createElement('div');
        container.className = 'item-container';
        
        const label = document.createElement('label');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.id;
        checkbox.checked = itemsSelected.has(item.id);
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            itemsSelected.add(item.id);
          } else {
            itemsSelected.delete(item.id);
          }
          renderPrintPreview();
          updateFolderCheckboxes();
        });
        
        label.appendChild(checkbox);
        
        const nameText = document.createTextNode(item.name || '(no name)');
        label.appendChild(nameText);
        
        container.appendChild(label);
        itemList.appendChild(container);
      });
    }

    // Update folder checkboxes based on selected items
    function updateFolderCheckboxes() {
      if (!data || !data.folders) return;
      
      // Check if all items are selected
      const allSelected = data.items.every(i => itemsSelected.has(i.id));
      if (document.querySelector('#all_items_checkbox')) {
        document.querySelector('#all_items_checkbox').checked = allSelected;
      }
      
      // Check if all no-folder items are selected
      const noFolderItems = data.items.filter(i => !i.folderId);
      const allNoFolderSelected = noFolderItems.length > 0 && 
                                 noFolderItems.every(i => itemsSelected.has(i.id));
      if (document.querySelector('#no_folder_checkbox')) {
        document.querySelector('#no_folder_checkbox').checked = allNoFolderSelected;
      }
      
      // Check individual folders
      data.folders.forEach(folder => {
        const itemsInFolder = data.items.filter(i => i.folderId === folder.id);
        const allFolderItemsSelected = itemsInFolder.length > 0 && 
                                      itemsInFolder.every(i => itemsSelected.has(i.id));
        
        const folderCheckbox = document.querySelector(`#folder_${folder.id}`);
        if (folderCheckbox) {
          folderCheckbox.checked = allFolderItemsSelected;
        }
        
        if (allFolderItemsSelected) {
          foldersSelected.add(folder.id);
        } else {
          foldersSelected.delete(folder.id);
        }
      });
    }

    // Render print preview
    function renderPrintPreview() {
      printContent.innerHTML = '';
      
      if (!data) {
        printContent.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><p>Load JSON file to see preview</p></div>';
        return;
      }
      
      const usePageBreak = pageBreakToggle.checked;
      const selectedItemsArr = data.items.filter(i => itemsSelected.has(i.id) && typesSelected.has(getItemType(i)));
      
      if (selectedItemsArr.length === 0) {
        printContent.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Select a folder or items to see preview</p></div>';
        return;
      }
      
      selectedItemsArr.forEach(item => {
        const container = document.createElement('div');
        container.classList.add('item-detail');
        if (usePageBreak) {
          container.classList.add('page-break');
        }
        
        // Title
        const title = document.createElement('h3');
        title.textContent = item.name || '(no name)';
        container.appendChild(title);
        
        // Folder info
        if (item.folderId) {
          const folder = data.folders.find(f => f.id === item.folderId);
          if (folder) {
            const folderInfo = document.createElement('div');
            folderInfo.innerHTML = `<div class="field-group">
              <span class="field-label">Folder:</span>
              <span class="field-value">${folder.name}</span>
            </div>`;
            container.appendChild(folderInfo);
          }
        }
        
        // Identity
        if (item.identity) {
          const identityDiv = document.createElement('div');
          identityDiv.className = 'identity-section';
          
          const identityTitle = document.createElement('div');
          identityTitle.className = 'section-title';
          identityTitle.innerHTML = '<i class="fas fa-id-card"></i> Identity';
          identityDiv.appendChild(identityTitle);
          
          const keyNamesPL = {
            title: 'Title', firstName: 'First Name', middleName: 'Middle Name', lastName: 'Last Name',
            address1: 'Address 1', address2: 'Address 2', address3: 'Address 3', city: 'City',
            state: 'State', postalCode: 'Postal Code', country: 'Country', phone: 'Phone',
            email: 'Email', ssn: 'SSN', passportNumber: 'Passport Number', company: 'Company'
          };
          
          for (const key of Object.keys(keyNamesPL)) {
            if (item.identity[key]) {
              const fieldGroup = document.createElement('div');
              fieldGroup.className = 'field-group';
              
              const fieldLabel = document.createElement('span');
              fieldLabel.className = 'field-label';
              fieldLabel.textContent = keyNamesPL[key] + ':';
              
              const fieldValue = document.createElement('span');
              fieldValue.className = 'field-value';
              fieldValue.textContent = item.identity[key];
              
              fieldGroup.appendChild(fieldLabel);
              fieldGroup.appendChild(fieldValue);
              identityDiv.appendChild(fieldGroup);
            }
          }
          
          container.appendChild(identityDiv);
        } 
        // SSH Key
        else if (item.sshKey) {
          const sshDiv = document.createElement('div');
          sshDiv.className = 'ssh-section';
          
          const sshTitle = document.createElement('div');
          sshTitle.className = 'section-title';
          sshTitle.innerHTML = '<i class="fas fa-key"></i> SSH Key';
          sshDiv.appendChild(sshTitle);
          
          if (item.sshKey.privateKey) {
            const privateKeyLabel = document.createElement('div');
            privateKeyLabel.className = 'field-label';
            privateKeyLabel.textContent = 'Private Key:';
            sshDiv.appendChild(privateKeyLabel);
            
            const prePk = document.createElement('pre');
            prePk.textContent = item.sshKey.privateKey;
            prePk.style.fontSize = '12px';
            prePk.style.background = '#f5f7fa';
            prePk.style.padding = '10px';
            prePk.style.borderRadius = '4px';
            prePk.style.overflow = 'auto';
            sshDiv.appendChild(prePk);
          }
          
          if (item.sshKey.publicKey) {
            const publicKeyLabel = document.createElement('div');
            publicKeyLabel.className = 'field-label';
            publicKeyLabel.style.marginTop = '15px';
            publicKeyLabel.textContent = 'Public Key:';
            sshDiv.appendChild(publicKeyLabel);
            
            const prePubk = document.createElement('pre');
            prePubk.textContent = item.sshKey.publicKey;
            prePubk.style.fontSize = '12px';
            prePubk.style.background = '#f5f7fa';
            prePubk.style.padding = '10px';
            prePubk.style.borderRadius = '4px';
            prePubk.style.overflow = 'auto';
            sshDiv.appendChild(prePubk);
          }
          
          if (item.sshKey.keyFingerprint) {
            const fpGroup = document.createElement('div');
            fpGroup.className = 'field-group';
            fpGroup.style.marginTop = '15px';
            
            const fpLabel = document.createElement('span');
            fpLabel.className = 'field-label';
            fpLabel.textContent = 'Fingerprint:';
            
            const fpValue = document.createElement('span');
            fpValue.className = 'field-value';
            fpValue.textContent = item.sshKey.keyFingerprint;
            
            fpGroup.appendChild(fpLabel);
            fpGroup.appendChild(fpValue);
            sshDiv.appendChild(fpGroup);
          }
          
          container.appendChild(sshDiv);
        } 
        // Login
        else if (item.login) {
          const loginDiv = document.createElement('div');
          loginDiv.className = 'login-section';
          
          const loginTitle = document.createElement('div');
          loginTitle.className = 'section-title';
          loginTitle.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
          loginDiv.appendChild(loginTitle);
          
          if (item.login.username) {
            const userGroup = document.createElement('div');
            userGroup.className = 'field-group';
            
            const userLabel = document.createElement('span');
            userLabel.className = 'field-label';
            userLabel.textContent = 'Username:';
            
            const userValue = document.createElement('span');
            userValue.className = 'field-value';
            userValue.textContent = item.login.username;
            
            userGroup.appendChild(userLabel);
            userGroup.appendChild(userValue);
            loginDiv.appendChild(userGroup);
          }
          
          if (item.login.password) {
            const passGroup = document.createElement('div');
            passGroup.className = 'field-group';
            
            const passLabel = document.createElement('span');
            passLabel.className = 'field-label';
            passLabel.textContent = 'Password:';
            
            const passValue = document.createElement('span');
            passValue.className = 'field-value';
            passValue.textContent = item.login.password;
            
            passGroup.appendChild(passLabel);
            passGroup.appendChild(passValue);
            loginDiv.appendChild(passGroup);
          }
          
          if (item.login.totp) {
            const totpGroup = document.createElement('div');
            totpGroup.className = 'field-group';
            
            const totpLabel = document.createElement('span');
            totpLabel.className = 'field-label';
            totpLabel.textContent = 'TOTP:';
            
            const totpValue = document.createElement('span');
            totpValue.className = 'field-value';
            totpValue.textContent = item.login.totp;
            
            totpGroup.appendChild(totpLabel);
            totpGroup.appendChild(totpValue);
            loginDiv.appendChild(totpGroup);
            
            const qrDiv = document.createElement('div');
            qrDiv.className = 'qr-code';
            loginDiv.appendChild(qrDiv);
            generateQRCode(qrDiv, item.login.totp);
          }
          
          if (item.login.uris && item.login.uris.length) {
            const uriTitle = document.createElement('div');
            uriTitle.className = 'section-title';
            uriTitle.style.fontSize = '14px';
            uriTitle.style.marginTop = '15px';
            uriTitle.innerHTML = '<i class="fas fa-link"></i> URLs';
            loginDiv.appendChild(uriTitle);
            
            const ul = document.createElement('ul');
            ul.className = 'uri-list';
            
            item.login.uris.forEach(uriObj => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = uriObj.uri;
              a.textContent = uriObj.uri;
              a.target = '_blank';
              li.appendChild(a);
              ul.appendChild(li);
            });
            
            loginDiv.appendChild(ul);
          }
          
          container.appendChild(loginDiv);
        }
        // Card
        else if (item.card) {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'card-section';
          
          const cardTitle = document.createElement('div');
          cardTitle.className = 'section-title';
          cardTitle.innerHTML = '<i class="fas fa-credit-card"></i> Credit Card';
          cardDiv.appendChild(cardTitle);
          
          const mapFields = {
            cardholderName: 'Cardholder Name',
            brand: 'Brand',
            number: 'Number',
            expMonth: 'Expiration Month',
            expYear: 'Expiration Year',
            code: 'CVV Code'
          };
          
          for (const key in mapFields) {
            if (item.card[key]) {
              const fieldGroup = document.createElement('div');
              fieldGroup.className = 'field-group';
              
              const fieldLabel = document.createElement('span');
              fieldLabel.className = 'field-label';
              fieldLabel.textContent = mapFields[key] + ':';
              
              const fieldValue = document.createElement('span');
              fieldValue.className = 'field-value';
              fieldValue.textContent = item.card[key];
              
              fieldGroup.appendChild(fieldLabel);
              fieldGroup.appendChild(fieldValue);
              cardDiv.appendChild(fieldGroup);
            }
          }
          
          container.appendChild(cardDiv);
        }
        
        // Notes
        if (item.notes) {
          const notesTitle = document.createElement('div');
          notesTitle.className = 'section-title';
          notesTitle.innerHTML = '<i class="fas fa-sticky-note"></i> Notes';
          container.appendChild(notesTitle);
          
          const notesEl = document.createElement('div');
          notesEl.className = 'notes';
          notesEl.textContent = item.notes;
          container.appendChild(notesEl);
        }
        
        // Additional fields
        if (item.fields && item.fields.length) {
          const keyFieldPL = {
            'username': 'Username',
            'password': 'Password'
          };
          
          const fieldsTitle = document.createElement('div');
          fieldsTitle.className = 'section-title';
          fieldsTitle.innerHTML = '<i class="fas fa-list-ul"></i> Additional Fields';
          container.appendChild(fieldsTitle);
          
          const fieldsContainer = document.createElement('div');
          fieldsContainer.className = 'additional-fields';
          
          const ul = document.createElement('ul');
          
          item.fields.forEach(f => {
            const li = document.createElement('li');
            
            const fieldLabel = document.createElement('span');
            fieldLabel.className = 'field-label';
            fieldLabel.style.display = 'inline-block';
            
            const fieldName = keyFieldPL[f.name.toLowerCase()] || f.name;
            fieldLabel.textContent = fieldName + ':';
            
            const fieldValue = document.createElement('span');
            fieldValue.className = 'field-value';
            fieldValue.style.marginLeft = '10px';
            fieldValue.textContent = f.value;
            
            li.appendChild(fieldLabel);
            li.appendChild(fieldValue);
            ul.appendChild(li);
          });
          
          fieldsContainer.appendChild(ul);
          container.appendChild(fieldsContainer);
        }
        
        printContent.appendChild(container);
      });
    }

    // Simple QR code generation
    function generateQRCode(container, text) {
      if (!text) return;
      container.innerHTML = '';
      try {
        // Attempt to extract the secret from otpauth URI if possible
        if (text) {
          try {
            const url = new URL(text);
            if (url.protocol === 'otpauth:' && url.hostname === 'totp') {
              const secret = url.searchParams.get('secret');
              if (secret) {
                text = 'otpauth://totp/Secret?secret=' + secret;
              }
            }
          } catch(e) {
            // not a valid URL, use full text
          }
          if (text.length <= 250) {
            new QRCode(container, {
              text: text,
              width: 200,
              height: 200,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });
          } else {
            console.warn('Skipped QR code generation: text length ' + text.length + ' is too long');
            container.textContent = 'QR code too long to generate';
          }
        } else {
          container.textContent = 'QR code data missing';
        }
      } catch (e) {
        console.warn('Failed to generate QR code:', e);
        container.textContent = 'QR code error';
      }
    }

    // Helper to generate plain text for TXT export
    function generatePlainText(items) {
      function escapeNewlines(s) {
        if (typeof s !== 'string' || !s) return '';
        return s.replace(/\n/g, '\\n');
      }
      let lines = [];
      items.forEach(item => {
        lines.push('Name: ' + (item.name || '(no name)'));
        if (item.folderId && data.folders) {
          const folder = data.folders.find(f => f.id === item.folderId);
          if (folder) lines.push('Folder: ' + folder.name);
        }
        if (item.identity) {
          lines.push('-- Identity --');
          for (const [key, label] of Object.entries({
            title: 'Title', firstName: 'First Name', middleName: 'Middle Name', lastName: 'Last Name',
            address1: 'Address 1', address2: 'Address 2', address3: 'Address 3', city: 'City', state: 'State',
            postalCode: 'Postal Code', country: 'Country', phone: 'Phone', email: 'Email', ssn: 'SSN',
            passportNumber: 'Passport Number', company: 'Company'
          })) {
            if (item.identity[key]) {
              lines.push(label + ': ' + escapeNewlines(item.identity[key]));
            }
          }
        } else if (item.sshKey) {
          lines.push('-- SSH Key --');
          if (item.sshKey.privateKey) lines.push('Private Key: ' + escapeNewlines(item.sshKey.privateKey));
          if (item.sshKey.publicKey) lines.push('Public Key: ' + escapeNewlines(item.sshKey.publicKey));
          if (item.sshKey.keyFingerprint) lines.push('Fingerprint: ' + item.sshKey.keyFingerprint);
        } else if (item.login) {
          lines.push('-- Login --');
          if (item.login.username) lines.push('Username: ' + item.login.username);
          if (item.login.password) lines.push('Password: ' + item.login.password);
          if (item.login.totp) lines.push('TOTP: ' + item.login.totp);
          if (item.login.uris) {
            lines.push('URLs:');
            item.login.uris.forEach(uriObj => {
              lines.push('  ' + uriObj.uri);
            });
          }
        } else if (item.card) {
          lines.push('-- Card --');
          if (item.card.cardholderName) lines.push('Cardholder Name: ' + escapeNewlines(item.card.cardholderName));
          if (item.card.brand) lines.push('Brand: ' + item.card.brand);
          if (item.card.number) lines.push('Number: ' + item.card.number);
          if (item.card.expMonth && item.card.expYear) lines.push('Expiration: ' + item.card.expMonth + '/' + item.card.expYear);
          if (item.card.code) lines.push('CVV Code: ' + item.card.code);
        }
        if (item.notes) lines.push('Notes: ' + escapeNewlines(item.notes));
        if (item.fields) {
          lines.push('Additional Fields:');
          const keyFieldPL = {username: 'Username', password: 'Password'};
          item.fields.forEach(f => {
            const fieldName = keyFieldPL[f.name.toLowerCase()] || f.name;
            lines.push('  ' + fieldName + ': ' + escapeNewlines(f.value));
          });
        }
        lines.push('');
      });
      return lines.join('\n');
    }

    // Export to TXT
    function exportToTxt() {
      if (!data) {
        alert('No data loaded for export.');
        return;
      }
      const selectedItemsArr = data.items.filter(i => itemsSelected.has(i.id) && typesSelected.has(getItemType(i)));
      if (selectedItemsArr.length === 0) {
        alert('Select at least one item to export.');
        return;
      }
      const content = generatePlainText(selectedItemsArr);
      const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'bitwarden_export.txt';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // Export to HTML
    function exportToHtml() {
      if (!data) {
        alert('No data loaded for export.');
        return;
      }
      const selectedItemsArr = data.items.filter(i => itemsSelected.has(i.id) && typesSelected.has(getItemType(i)));
      if (selectedItemsArr.length === 0) {
        alert('Select at least one item to export.');
        return;
      }
      // Build minimal HTML
      const htmlParts = [];
      htmlParts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Bitwarden Export</title>');
      htmlParts.push('<style>body {font-family: "Segoe UI", Roboto, -apple-system, sans-serif; margin: 20px; color: #333; line-height: 1.6;} .item-detail { border-left: 4px solid #000; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); padding: 20px; margin-bottom: 25px; } h3 { color: #000; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; } .field-label { font-weight: 500; min-width: 120px; color: #666; display: inline-block; } .field-value { word-break: break-all; } .section-title { font-weight: 600; margin-top: 15px; margin-bottom: 8px; color: #000; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; } .notes { margin-top: 15px; padding: 10px; background-color: #f5f7fa; border-radius: 4px; font-style: italic; white-space: pre-wrap; } .uri-list { list-style-type: none; padding-left: 0; } .uri-list li { margin-bottom: 5px; } .uri-list a { color: #000; text-decoration: none; } .uri-list a:hover { text-decoration: underline; } .additional-fields { margin-top: 15px; } .additional-fields ul { list-style-type: none; padding-left: 0; } .additional-fields li { margin-bottom: 8px; padding: 8px 10px; background-color: #f5f7fa; border-radius: 4px; } .qr-code { text-align: center; margin: 15px 0; } .qr-code img, .qr-code canvas { width: 200px; height: 200px; }</style>');
      htmlParts.push('</head><body>');
      selectedItemsArr.forEach(item => {
        htmlParts.push('<div class="item-detail">');
        htmlParts.push('<h3>' + (item.name || '(no name)') + '</h3>');
        if (item.folderId && data.folders) {
          const folder = data.folders.find(f => f.id === item.folderId);
          if (folder) htmlParts.push('<div><span class="field-label">Folder:</span> <span class="field-value">' + folder.name + '</span></div>');
        }
        if (item.identity) {
          htmlParts.push('<div class="section-title">Identity</div>');
          htmlParts.push('<div class="identity-section">');
          const keyNamesPL = {
            title: 'Title', firstName: 'First Name', middleName: 'Middle Name', lastName: 'Last Name',
            address1: 'Address 1', address2: 'Address 2', address3: 'Address 3', city: 'City',
            state: 'State', postalCode: 'Postal Code', country: 'Country', phone: 'Phone',
            email: 'Email', ssn: 'SSN', passportNumber: 'Passport Number', company: 'Company'
          };
          for (const key of Object.keys(keyNamesPL)) {
            if (item.identity[key]) {
              htmlParts.push('<div><span class="field-label">' + keyNamesPL[key] + ':</span> <span class="field-value">' + item.identity[key] + '</span></div>');
            }
          }
          htmlParts.push('</div>');
        } else if (item.sshKey) {
          htmlParts.push('<div class="section-title">SSH Key</div>');
          htmlParts.push('<div class="ssh-section">');
          if (item.sshKey.privateKey) {
            htmlParts.push('<div class="field-label">Private Key:</div><pre style="background: #f5f7fa; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px;">' + item.sshKey.privateKey + '</pre>');
          }
          if (item.sshKey.publicKey) {
            htmlParts.push('<div class="field-label" style="margin-top: 15px;">Public Key:</div><pre style="background: #f5f7fa; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px;">' + item.sshKey.publicKey + '</pre>');
          }
          if (item.sshKey.keyFingerprint) {
            htmlParts.push('<div style="margin-top: 15px;"><span class="field-label">Fingerprint:</span> <span class="field-value">' + item.sshKey.keyFingerprint + '</span></div>');
          }
          htmlParts.push('</div>');
        } else if (item.login) {
          htmlParts.push('<div class="section-title">Login</div>');
          htmlParts.push('<div class="login-section">');
          if (item.login.username) {
            htmlParts.push('<div><span class="field-label">Username:</span> <span class="field-value">' + item.login.username + '</span></div>');
          }
          if (item.login.password) {
            htmlParts.push('<div><span class="field-label">Password:</span> <span class="field-value">' + item.login.password + '</span></div>');
          }
          if (item.login.totp) {
            htmlParts.push('<div><span class="field-label">TOTP:</span> <span class="field-value">' + item.login.totp + '</span></div>');
            const qrDiv = document.createElement('div');
            qrDiv.className = 'qr-code';
            generateQRCode(qrDiv, item.login.totp);
            const qrCanvas = qrDiv.querySelector('canvas');
            if (qrCanvas && qrCanvas.toDataURL) {
              htmlParts.push('<div class="qr-code"><img src="' + qrCanvas.toDataURL() + '" /></div>');
            } else {
              htmlParts.push(qrDiv.outerHTML);
            }
          }
          if (item.login.uris && item.login.uris.length) {
            htmlParts.push('<div class="section-title" style="font-size: 14px; margin-top: 15px;">URLs</div>');
            htmlParts.push('<ul class="uri-list">');
            item.login.uris.forEach(uriObj => {
              htmlParts.push('<li><a href="' + uriObj.uri + '" target="_blank">' + uriObj.uri + '</a></li>');
            });
            htmlParts.push('</ul>');
          }
          htmlParts.push('</div>');
        } else if (item.card) {
          htmlParts.push('<div class="section-title">Credit Card</div>');
          htmlParts.push('<div class="card-section">');
          const mapFields = {
            cardholderName: 'Cardholder Name',
            brand: 'Brand',
            number: 'Number',
            expMonth: 'Expiration Month',
            expYear: 'Expiration Year',
            code: 'CVV Code'
          };
          for (const key in mapFields) {
            if (item.card[key]) {
              htmlParts.push('<div><span class="field-label">' + mapFields[key] + ':</span> <span class="field-value">' + item.card[key] + '</span></div>');
            }
          }
          htmlParts.push('</div>');
        }

        if (item.notes) {
        htmlParts.push('<div class="section-title">Notes</div>');
          htmlParts.push('<div class="notes">' + item.notes + '</div>');
        }

        if (item.fields && item.fields.length) {
          htmlParts.push('<div class="section-title">Additional Fields</div>');
          htmlParts.push('<div class="additional-fields">');
          htmlParts.push('<ul>');
          const keyFieldPL = {username: 'Username', password: 'Password'};
          item.fields.forEach(f => {
            const fieldName = keyFieldPL[f.name.toLowerCase()] || f.name;
            htmlParts.push('<li><span class="field-label">' + fieldName + ':</span> <span class="field-value">' + f.value + '</span></li>');
          });
          htmlParts.push('</ul>');
          htmlParts.push('</div>');
        }
        htmlParts.push('</div>');
      });
      htmlParts.push('</body></html>');

      const content = htmlParts.join('');
      const blob = new Blob([content], {type: 'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bitwarden_export.html';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>